# アーキテクチャ

## システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                     EventBridge Scheduler                    │
│  (1日4回: 9:00, 12:00, 18:00, 21:00 JST)                    │
└───────────────────────┬─────────────────────────────────────┘
                        │ トリガー
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                   Lambda Function                            │
│              (Docker コンテナベース)                          │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 1. GitHub API                                         │   │
│  │    └─ コントリビューションデータ取得                  │   │
│  │                                                        │   │
│  │ 2. Canvas                                              │   │
│  │    └─ 草画像生成 (PNG)                                │   │
│  │                                                        │   │
│  │ 3. S3 Service                                          │   │
│  │    └─ 画像アップロード                                │   │
│  │                                                        │   │
│  │ 4. LINE Messaging API                                  │   │
│  │    └─ Push通知送信                                    │   │
│  └──────────────────────────────────────────────────────┘   │
└───────┬──────────────────────────────────┬──────────────────┘
        │                                  │
        ▼                                  ▼
┌────────────────┐              ┌──────────────────────┐
│  S3 Bucket     │              │  LINE Messaging API  │
│  (画像保存)     │              │                      │
│  - Public Read │              │  ┌────────────────┐  │
│  - 30日で削除  │              │  │   LINEユーザー  │  │
└────────────────┘              │  │   (あなた)      │  │
                                │  └────────────────┘  │
                                └──────────────────────┘
```

## コンポーネント詳細

### 1. EventBridge Scheduler

**役割**: Lambda関数を定期的に実行

**設定**:
- 実行スケジュール: 1日4回（Cron式）
  - 朝: 9:00 JST (UTC 0:00)
  - 昼: 12:00 JST (UTC 3:00)
  - 夕方: 18:00 JST (UTC 9:00)
  - 夜: 21:00 JST (UTC 12:00)

**無料枠**: 月1,400万回まで無料

### 2. Lambda Function

**役割**: メインの処理を実行

**スペック**:
- ランタイム: Node.js 20.x (Docker コンテナ)
- メモリ: 512MB
- タイムアウト: 30秒
- 実行時間: 約5-10秒（予想）

**環境変数**:
- `GITHUB_USERNAME`: GitHubユーザー名
- `GITHUB_TOKEN`: GitHub Personal Access Token
- `LINE_CHANNEL_ACCESS_TOKEN`: LINEチャネルアクセストークン
- `LINE_USER_ID`: LINE ユーザーID
- `S3_BUCKET_NAME`: S3バケット名

**無料枠**: 月100万リクエスト + 400,000 GB-秒まで無料

#### なぜDockerコンテナベース？

Canvas はネイティブモジュール（C++）を使用しており、通常の Lambda では動作しません。
Docker コンテナを使用することで、Cairo などの必要なシステムライブラリをインストールできます。

### 3. S3 Bucket

**役割**: 生成された草画像を保存

**設定**:
- パブリック読み取りアクセス: 有効
- CORS: GET メソッドを許可
- ライフサイクル: 30日後に自動削除

**命名規則**: `grass-canvas-{AWSアカウントID}`

**無料枠**: 5GB まで無料

### 4. LINE Messaging API

**役割**: ユーザーにプッシュ通知を送信

**メッセージ形式**:
1. テキストメッセージ（総コントリビューション数、更新時刻）
2. 画像メッセージ（草画像）

**無料枠**: 月200通まで無料（コミュニケーションプラン）

## データフロー

```
1. EventBridge がスケジュールに従って Lambda を起動

2. Lambda が GitHub GraphQL API を呼び出し
   └─ 過去1年分のコントリビューションデータを取得

3. Canvas で草画像を生成
   └─ GitHubと同じ色・レイアウトで描画

4. S3 に画像をアップロード
   └─ ファイル名: grass/{username}/{timestamp}.png
   └─ パブリック URL を取得

5. LINE Messaging API で通知
   └─ テキスト + 画像の2つのメッセージを送信

6. ユーザーの LINE に通知が届く
```

## セキュリティ

### 認証・認可

- **GitHub API**: Personal Access Token（環境変数で設定）
- **LINE Messaging API**: チャネルアクセストークン（環境変数で設定）
- **AWS**: Lambda実行ロールによる IAM ベースの認証

### データ保護

- 環境変数は AWS Systems Manager Parameter Store または Secrets Manager で管理可能
- S3 画像は30日後に自動削除（古いデータの蓄積を防ぐ）

### ネットワーク

- Lambda は VPC 外で実行（インターネットアクセスが必要なため）
- S3 はパブリックアクセス（LINE が画像を取得できるように）

## コスト最適化

### 無料枠の活用

| サービス | 使用量（月） | 無料枠 | 想定コスト |
|---------|-------------|--------|-----------|
| Lambda | 120回実行<br>約720秒実行時間 | 100万リクエスト<br>400,000 GB-秒 | $0 |
| EventBridge | 120回呼び出し | 1,400万回 | $0 |
| S3 | 約120枚（30日で削除）<br>約10MB | 5GB | $0 |
| LINE | 120通（1日4通×30日） | 200通 | $0 |
| **合計** | - | - | **$0** |

### コスト削減のヒント

1. **実行回数を調整**: 1日4回 → 2回に減らせば半額
2. **画像の解像度を下げる**: ファイルサイズが小さくなり S3 コストが削減
3. **Lambda のメモリを最適化**: 実際の使用量に合わせて調整

## スケーラビリティ

### 複数ユーザー対応

現在の設計は1ユーザー用ですが、以下の変更で複数ユーザーに対応可能：

1. DynamoDB でユーザー設定を管理
2. Lambda でユーザーリストをループ処理
3. 環境変数ではなく、DynamoDB から設定を読み込み

### 通知頻度の変更

EventBridge Scheduler の Cron 式を変更するだけで簡単に調整可能。

## モニタリング

### CloudWatch Logs

Lambda の実行ログが自動的に記録されます：

- 実行開始/終了
- エラーメッセージ
- GitHub API レスポンス
- S3 アップロード結果
- LINE 通知結果

### CloudWatch Metrics

- Lambda 実行回数
- Lambda 実行時間
- Lambda エラー率
- S3 リクエスト数

### アラーム設定（オプション）

- Lambda エラー率が 50% を超えたら SNS で通知
- S3 バケットサイズが 4GB を超えたら警告

## 拡張可能性

### 追加機能の候補

1. **週次サマリー**: 週に1回、詳細なレポートを送信
2. **目標達成通知**: 特定のコントリビューション数に到達したら祝福メッセージ
3. **比較機能**: 前週/前月との比較グラフ
4. **リマインダー**: コントリビューションがない日が続いたら警告
5. **複数アカウント対応**: 複数の GitHub アカウントを監視

### 技術的な拡張

1. **CloudFront 導入**: S3 の代わりに CloudFront で画像配信（高速化）
2. **Step Functions**: 複雑なワークフローを管理
3. **SQS**: 非同期処理でスケーラビリティ向上
4. **API Gateway**: 手動実行用の REST API エンドポイント
